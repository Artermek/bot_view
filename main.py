from typing import List
import os
import base64
import asyncio

from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI

# Если хотите хранить OPENAI_API_KEY в .env локально:
from dotenv import load_dotenv
app = FastAPI()

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://siriusfuture.ru",
        "https://www.siriusfuture.ru",
        "https://*.tilda.ws",
        "https://tilda.cc",
        "https://static.tildacdn.com",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Промпт для категории «Дом, Дерево, Человек»
PROMPT_HOUSE_TREE_PERSON = """
Перед тобой — скан или фотография детского рисунка темы «Дом, дерево, человек».
Твоя задача на основе критериев оценки проанализировать фотографию и в каждом пункте
выбрать критерий, который ближе подходит к рисунку.
Ответ дай без маркдаун разметки, но с использованием "/n" разметки

                                Базовые критерии оценки рисунка:
                                    I. Общие характеристики и организация рисунка:
                                    1. Размер рисунка:
                                    - Большой размер: Может указывать на экстраверсию, уверенность в себе, экспансивность, иногда – на потребность в признании или компенсирующую гигантоманию.
                                    - Маленький размер: Может указывать на интроверсию, неуверенность, застенчивость, чувство неполноценности, подавленность.
                                    2. Расположение на листе:
                                    - В центре: Может указывать на адаптивность, уравновешенность, потребность в признании.
                                    - Сверху: Может указывать на идеализм, ориентацию на будущее, фантазии, иногда – на оторванность от реальности.
                                    - Снизу: Может указывать на ориентацию на прошлое, чувство незащищенности, потребность в опоре.
                                    - Слева: Может указывать на ориентацию на прошлое, интроверсию, зависимость от материнской фигуры.
                                    - Справа: Может указывать на ориентацию на будущее, экстраверсию, потребность в общении, зависимость от отцовской фигуры.
                                    3. Сила нажима:
                                    - Сильный нажим: Может указывать на энергичность, импульсивность, настойчивость, иногда – на агрессивность.
                                    - Слабый нажим: Может указывать на чувствительность, мягкость, уступчивость, астению, тревожность.
                                    4. Характер линий:
                                    - Четкие, ровные линии: Может указывать на контроль, рациональность, уверенность.
                                    - Прерывистые, неровные линии: Может указывать на тревожность, неуверенность, импульсивность.
                                    - Заштрихованные, затемненные линии: Может указывать на тревожность, чувство вины, подавленные эмоции.
                                    5. Общая композиция:
                                    - Гармоничная, сбалансированная композиция: Может указывать на уравновешенность, адаптивность.
                                    - Перегруженная, хаотичная композиция: Может указывать на тревожность, внутренний конфликт.
                                    - Пустая, минималистичная композиция: Может указывать на интроверсию, подавленность, чувство одиночества.
                                    II. Оценка рисунка Дома:
                                    1. Общее впечатление: Дом – символ “Я”, семейных отношений, безопасности.
                                    2. Фундамент: Опора, связь с реальностью, уверенность.
                                    - Наличие фундамента: Устойчивость, реалистичность.
                                    - Отсутствие фундамента: Неуверенность, оторванность от реальности.
                                    - Слабый, нечеткий фундамент: Неуверенность, потребность в опоре.
                                    3. Стены: Границы “Я”, способ взаимодействия с внешним миром.
                                    - Крепкие стены: Сильное “Я”, уверенность в себе.
                                    - Слабые, тонкие стены: Чувствительность, уязвимость.
                                    - Заштрихованные стены: Тревожность, чувство вины.
                                    4. Крыша: Интеллектуальная сфера, фантазии, контроль.
                                    - Большая крыша: Развитая фантазия, интеллектуальные интересы.
                                    - Маленькая крыша: Ограниченность фантазии, рациональность.
                                    - Отсутствие крыши: Импульсивность, недостаток контроля.
                                    5. Дверь: Доступность, открытость, способ взаимодействия с другими людьми.
                                    - Большая дверь: Экстраверсия, потребность в общении.
                                    - Маленькая дверь: Интроверсия, замкнутость.
                                    - Закрытая дверь: Недоступность, замкнутость.
                                    - Дверь без ручки: Нежелание общаться.
                                    6. Окна: Контакт с внешним миром, наблюдательность.
                                    - Большие окна: Интерес к окружающему миру, потребность в общении.
                                    - Маленькие окна: Ограниченный интерес к окружающему миру.
                                    - Занавески на окнах: Желание скрыть что-то от других.
                                    - Отсутствие окон: Изоляция, отчужденность.
                                    7. Труба: Символ тепла, близости, сексуальности.
                                    - Дым из трубы: Эмоциональная теплота, потребность в близости.
                                    - Отсутствие дыма: Подавление эмоций.
                                    - Интенсивный дым: Тревожность, напряжение.
                                    - Труба без дома: Оторванность от реальности, фантазии.
                                    III. Оценка рисунка Дерева:
                                    1. Общее впечатление: Дерево – символ развития, жизненной силы, самооценки.
                                    2. Корни: Связь с прошлым, стабильность, уверенность.
                                    - Наличие корней: Устойчивость, связь с реальностью.
                                    - Отсутствие корней: Неуверенность, оторванность от реальности.
                                    - Подчеркнутые корни: Тревожность, потребность в защите.
                                    3. Ствол: Сила “Я”, адаптивность, способность к выживанию.
                                    - Крепкий ствол: Сильное “Я”, устойчивость.
                                    - Тонкий ствол: Чувствительность, уязвимость.
                                    - Искривленный ствол: Внутренний конфликт, трудности адаптации.
                                    - Раны, дупла на стволе: Травматический опыт.
                                    4. Ветви: Способ взаимодействия с окружающим миром, социальные контакты.
                                    - Поднятые вверх ветви: Оптимизм, стремление к достижению.
                                    - Опущенные вниз ветви: Пессимизм, подавленность.
                                    - Колючие ветви: Агрессивность, защита.
                                    - Обрубленные ветви: Чувство утраты, ограничение возможностей.
                                    5. Крона: Интеллектуальная сфера, фантазии, творчество.
                                    - Пышная крона: Развитая фантазия, творческие способности.
                                    - Небольшая крона: Ограниченность фантазии, рациональность.
                                    - Отсутствие кроны: Интеллектуальная пассивность.
                                    6. Плоды, листья: Достижения, результаты деятельности, ресурсы.
                                    - Наличие плодов, листьев: Плодотворность, ресурсность.
                                    - Отсутствие плодов, листьев: Неудовлетворенность, ощущение недостатка ресурсов.
                                    IV. Оценка рисунка Человека:
                                    1. Общее впечатление: Человек – символ “Я”, самооценки, идентификации.
                                    2. Голова: Интеллектуальная сфера, самосознание.
                                    - Большая голова: Высокая самооценка, интеллектуальные амбиции.
                                    - Маленькая голова: Низкая самооценка, интеллектуальная пассивность.
                                    - Подчеркнутые глаза: Интерес к окружающему миру, потребность в общении.
                                    - Закрытые глаза: Нежелание видеть, избегание.
                                    - Большие уши: Потребность во внимании, чувствительность к критике.
                                    - Отсутствие ушей: Игнорирование мнения других.
                                    3. Тело: Физическое “Я”, сила, энергия.
                                    - Широкие плечи: Стремление к власти, доминированию.
                                    - Узкие плечи: Чувство неполноценности, слабость.
                                    - Подчеркнутые мускулы: Стремление к силе, компенсация слабости.
                                    4. Руки: Способ взаимодействия с окружающим миром, активность.
                                    - Сильные руки: Активность, энергичность.
                                    - Слабые руки: Пассивность, зависимость.
                                    - Спрятанные руки: Чувство вины, неловкость.
                                    - Руки, направленные на себя: Аутоагрессия.
                                    5. Ноги: Опора, связь с реальностью, уверенность.
                                    - Сильные ноги: Устойчивость, уверенность.
                                    - Слабые ноги: Неуверенность, потребность в опоре.
                                    - Короткие ноги: Импульсивность, недостаток контроля.
                                    6.Одежда: Способ самопредставления, социальные нормы.
                                    - Подробная одежда: Потребность в признании, стремление произвести впечатление.
                                    - Минимальная одежда: Скромность, простота.
                                    - Неопрятная одежда:
                                    """.strip()

# Промпт для категории «Несуществующее животное»
PROMPT_ANIMAL = """
    Перед тобой — скан или фотография детского рисунка темы «Дом, дерево, человек».
    Твоя задача на основе критериев оценки проанализировать фотографию и в каждом пункте
    выбрать критерий, который ближе подходит к рисунку.
    Ответ дай без маркдаун разметки, но с использованием "/n" разметки
    
    Базовые критерии оценки:
    I. Общие характеристики и организация рисунка:
    1. Размер животного:
    - Большой: Может указывать на стремление к самоутверждению, высокую самооценку, экстраверсию, иногда компенсацию чувства неполноценности.
    - Средний: Адаптированность, уравновешенность, реалистичность.
    - Маленький: Неуверенность, застенчивость, интроверсия, чувство неполноценности.
    2. Расположение на листе:
    - В центре: Адаптивность, уравновешенность.
    - Сверху: Фантазии, идеализм, оторванность от реальности.
    - Снизу: Неуверенность, потребность в опоре.
    - Слева: Ориентация на прошлое, зависимость от матери.
    - Справа: Ориентация на будущее, зависимость от отца.
    3. Сила нажима:
    - Сильный: Энергичность, импульсивность, агрессивность.
    - Слабый: Чувствительность, тревожность, астения.
    4. Характер линий:
    - Четкие, ровные: Контроль, уверенность, рациональность.
    - Прерывистые, неровные: Тревожность, неуверенность, импульсивность.
    - Заштрихованные: Тревожность, чувство вины, подавленные эмоции.
    5. Общая композиция:
    - Сбалансированная: Уравновешенность, адаптивность.
    - Перегруженная: Тревожность, внутренний конфликт.
    - Минималистичная: Интроверсия, подавленность.
    II. Анализ деталей животного:
    1. Голова: Интеллектуальная сфера, контроль, самосознание.
    - Большая голова: Развитый интеллект, стремление к знаниям.
    - Маленькая голова: Интеллектуальная пассивность, неуверенность в своих способностях.
    - Глаза: Контакт с внешним миром, социальная ориентированность.
    - Большие, широко открытые глаза: Интерес к окружающему миру, потребность в общении, любопытство.
    - Маленькие, узкие глаза: Ограниченный интерес к окружающему миру, скрытность.
    - Глаза без зрачков: Эмоциональная отстраненность, избегание контакта.
    - Подчеркнутые ресницы: Демонстративность, потребность во внимании.
    2. Рот: Агрессивность, потребность в общении, удовлетворение потребностей.
    - Большой, открытый рот: Агрессивность, потребность в выражении эмоций.
    - Рот с зубами: Агрессивность, защита, стремление к доминированию.
    - Маленький, закрытый рот: Подавление эмоций, застенчивость.
    - Отсутствие рта: Трудности в общении, подавление потребностей.
    3. Уши: Восприятие информации, отношение к критике.
    - Большие уши: Потребность во внимании, повышенная чувствительность к критике.
    - Маленькие уши: Игнорирование мнения других, независимость.
    - Отсутствие ушей: Отрицание внешней информации, замкнутость.
    4. Рога, когти, зубы, шипы: Защита, агрессия, стремление к доминированию.
    - Большое количество рогов, когтей, зубов, шипов: Высокий уровень агрессии, потребность в защите.
    - Отсутствие рогов, когтей, зубов, шипов: Отсутствие агрессии, беззащитность, слабость.
    5. Крылья, плавники, перепонки: Стремление к свободе, независимости, адаптивности.
    - Наличие крыльев: Стремление к свободе, фантазиям, уходу от реальности.
    - Наличие плавников: Адаптивность, приспособляемость к различным условиям.
    6. Хвост: Контроль, импульсивность, влияние прошлого.
    - Длинный хвост: Влияние прошлого, воспоминания, привязанность.
    - Короткий хвост: Импульсивность, недостаток контроля.
    - Поднятый вверх хвост: Уверенность, оптимизм.
    - Опущенный вниз хвост: Подавленность, пессимизм.
    III. Анализ названия животного и описания:
    1. Название: Может отражать особенности личности, страхи, желания, ассоциации.
    - Простое, понятное название: Реалистичность, адаптивность.
    - Сложное, необычное название: Фантазия, креативность.
    - Агрессивное, угрожающее название: Агрессивность, потребность в доминировании.
    - Смешное, нелепое название: Юмор, самоирония, отрицание проблем.
    2. Описание: Может раскрыть отношение ребенка к животному, его характер, сильные и слабые стороны.
    - Описание животного как сильного, смелого, уверенного: Стремление к этим качествам, высокая самооценка.
    - Описание животного как слабого, беззащитного, нуждающегося в помощи: Низкая самооценка, потребность в защите.
    - Описание животного как доброго, дружелюбного: Стремление к общению, потребность в любви и принятии.
    - Описание животного как злого, агрессивного: Агрессивность, подавленные эмоции.
    IV. Среда обитания и образ жизни животного:
    - Место обитания: Может указывать на предпочтения, интересы и страхи ребенка. (Например, если животное живет в темноте, это может указывать на страхи темноты или неизведанного).
    - Способ питания: Может указывать на удовлетворение потребностей (как физических, так и эмоциональных).
    -  Взаимодействие с другими животными: Может отражать особенности межличностных отношений ребенка.
    """.strip()

    # Промпт для категории «Автопортрет»
PROMPT_SELF_PORTRAIT = """
    Перед тобой — скан или фотография детского рисунка темы «Дом, дерево, человек».
    Твоя задача на основе критериев оценки проанализировать фотографию и в каждом пункте
    выбрать критерий, который ближе подходит к рисунку.
    Ответ дай без маркдаун разметки, но с использованием "/n" разметки
    
    Базовые критерии оценки:
    I. Общие характеристики и организация рисунка:
    1. Размер фигуры:
    - Большой размер: Может указывать на высокую самооценку, уверенность в себе, стремление к демонстрации, потребность во внимании. Иногда - компенсация чувства неполноценности.
    - Средний размер: Адаптированность, реалистичность, адекватная самооценка.
    - Маленький размер: Неуверенность, застенчивость, низкая самооценка, чувство неполноценности.
    2. Расположение на листе:
    - В центре: Уверенность, потребность в признании, адекватная самооценка.
    - Сверху: Идеализм, высокие амбиции, оторванность от реальности. Может указывать на завышенную самооценку.
    - Снизу: Неуверенность, потребность в опоре, зависимость от других. Может указывать на заниженную самооценку.
    - Слева: Интроверсия, ориентация на прошлое, зависимость от матери. Может указывать на рефлексию и самоанализ.
    - Справа: Экстраверсия, ориентация на будущее, потребность в общении. Может указывать на стремление к новым впечатлениям и контактам.
    3. Сила нажима:
    - Сильный: Энергичность, импульсивность, уверенность.
    - Слабый: Чувствительность, тревожность, астения, неуверенность.
    4. Характер линий:
    - Четкие, ровные: Контроль, уверенность, рациональность.
    - Прерывистые, неровные: Тревожность, неуверенность, импульсивность.
    - Заштрихованные: Тревожность, чувство вины, подавленные эмоции, ощущение дискомфорта.
    5. Общая композиция:
    - Сбалансированная: Гармоничное восприятие себя, уравновешенность.
    - Перегруженная: Тревожность, внутренний конфликт, переизбыток эмоций.
    - Минималистичная: Интроверсия, подавленность, чувство одиночества, недостаток энергии.
    II. Анализ деталей фигуры:
    1. Голова: Интеллектуальная сфера, самосознание, контроль.
    - Большая голова: Высокая самооценка в интеллектуальной сфере, стремление к знаниям, развитое самосознание. Может указывать на интеллектуальные амбиции.
    - Маленькая голова: Низкая самооценка в интеллектуальной сфере, интеллектуальная пассивность, неуверенность в своих способностях.
    2. Лицо: Эмоциональное выражение, социальная ориентированность.
    Глаза:
    - Большие, широко открытые: Интерес к окружающему миру, потребность в общении, открытость, любопытство.
    - Маленькие, узкие: Скрытность, осторожность, ограниченный интерес к окружающему миру.
    - Глаза без зрачков: Эмоциональная отстраненность, избегание контакта.
    -  Подчеркнутые ресницы: Демонстративность, потребность во внимании, кокетство.
    Рот:
    - Улыбка: Позитивное отношение к себе, хорошее настроение, дружелюбие.
    - Прямая линия: Контроль, сдержанность, подавление эмоций.
    - Опущенные уголки рта: Пессимизм, подавленность, грусть.
    - Большой, открытый рот: Агрессивность, потребность в выражении эмоций (в зависимости от контекста может быть просто разговорчивость).
    Уши:
    - Большие уши: Потребность во внимании, повышенная чувствительность к критике.
    - Маленькие уши: Игнорирование мнения других, независимость.
    - Отсутствие ушей: Отрицание внешней информации, замкнутость.
    3. Тело: Физическое “Я”, сила, энергия, самооценка.
    - Широкие плечи: (Для мальчиков) Стремление к силе, доминированию, уверенность в себе.
    - Узкие плечи: Чувство неполноценности, слабость, неуверенность (чаще у мальчиков).
    - Тонкая шея: Чувствительность, уязвимость, хрупкость.
    - Короткая шея: Упрямство, ригидность, недостаток гибкости.
    - Подчеркнутая талия: (Для девочек) Интерес к своей внешности, стремление к привлекательности.
    4. Руки: Способ взаимодействия с окружающим миром, активность.
    - Длинные, сильные руки: Активность, уверенность в себе, способность достигать целей.
    - Короткие, слабые руки: Пассивность, зависимость, неуверенность в своих силах.
    - Спрятанные за спиной руки: Чувство вины, стеснительность, нежелание действовать.
    - Руки, направленные на себя: Аутоагрессия, самокритика.
    5. Ноги: Опора, связь с реальностью, устойчивость, уверенность.
    - Длинные, сильные ноги: Уверенность в себе, стремление к независимости, активная жизненная позиция.
    - Короткие, слабые ноги: Неуверенность, зависимость от других, потребность в опоре.
    6. Одежда: Способ самопредставления, социальные нормы, стремление к соответствию.
    - Подробная, тщательно прорисованная одежда: Стремление произвести впечатление, потребность во внимании, соответствие социальным нормам.
    - Схематичная одежда: Скромность, нежелание привлекать внимание, безразличие к социальным нормам.
    - Неопрятная одежда: Пренебрежение к себе, низкая самооценка, бунтарство.

""".strip()

@app.post("/upload")
async def upload_images(files: List[UploadFile] = File(...)):
    """
    Принимает ровно 3 файла под ключом 'files' и возвращает список из 3 ответов.
    """
    if len(files) != 3:
        raise HTTPException(400, f"Ожидалось 3 файла, пришло {len(files)}")

    prompts = [
        PROMPT_HOUSE_TREE_PERSON,
        PROMPT_ANIMAL,
        PROMPT_SELF_PORTRAIT,
    ]

    # Считываем и кодируем
    prepared = []
    for idx, (file, prompt) in enumerate(zip(files, prompts), start=1):
        if not file.content_type.startswith("image/"):
            raise HTTPException(400, f"file#{idx} не изображение: {file.content_type}")
        data = await file.read()
        b64 = base64.b64encode(data).decode("utf-8")
        prepared.append((file.content_type, b64, prompt, idx))

    # Асинхронный вызов OpenAI в пуле потоков
    async def analyze(content_type, b64, prompt, idx):
        loop = asyncio.get_running_loop()
        def call_openai():
            client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
            resp = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[{
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {"type": "image_url", "image_url": {
                            "url": f"data:{content_type};base64,{b64}"
                        }}
                    ]
                }]
            )
            return resp.choices[0].message.content

        try:
            return await loop.run_in_executor(None, call_openai)
        except Exception as e:
            return f"Ошибка анализа файла #{idx}: {e}"

    # Параллельно
    tasks = [analyze(ct, b64, prmpt, idx) for ct, b64, prmpt, idx in prepared]
    results = await asyncio.gather(*tasks)

    return JSONResponse({"analyses": results})