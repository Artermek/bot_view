from typing import List
import os
import base64
import uuid

from fastapi import FastAPI, UploadFile, File, HTTPException, BackgroundTasks
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI

# Если хотите хранить OPENAI_API_KEY в .env локально:
from dotenv import load_dotenv
app = FastAPI()

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://siriusfuture.ru",
        "https://www.siriusfuture.ru",
        "https://*.tilda.ws",
        "https://tilda.cc",
        "https://static.tildacdn.com",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Промпт для категории «Дом, Дерево, Человек»
PROMPT_HOUSE_TREE_PERSON = """Перед тобой — скан или фотография детского рисунка на тему «Дом, дерево, человек». Твоя задача провести анализ в два этапа:
сначала измерить и зафиксировать ключевые визуальные параметры, затем отнести каждое значение к одному из психологических критериев.
В ответе укажи только результаты с Этапа 2. 


Этап 1. Извлечение признаков
Для каждого пункта замерь или оценить приблизительно в миллиметрах (или в процентах от объекта/листа):
— Общий размер рисунка (процент заполнения листа)
— Толщину линий (средняя ширина штриха в мм)
— Положение объектов (координаты центра относительно листа или «слева/в центре/справа»)
— Для дома: ширина и высота корпуса, размеры крыши, размеры двери и окон, наличие фундамента (линия земли)
— Для дерева: высота ствола, длина корней, размеры кроны
— Для человека: рост, ширина плеч, длина рук, длина ног, размер головы

Этап 2. Классификация по критериям
Используя измеренные величины, для каждого пункта выбери ровно один критерий и приведи обоснование на основе цифр, в ответе обязательно 
напиши критерий и на что он может указывать, а так же приведи обоснование на основе цифр:
Общее характеристики:
1. Размер рисунка: 
    - Большой размер (рисунок занимает >65 % листа). Может указывать на экстраверсию, уверенность в себе, экспансивность, 
    иногда – на потребность в признании или компенсирующую гигантоманию. 
    - Маленький размер (рисунок занимает <65 % листа). Может указывать на интроверсию, неуверенность, застенчивость, чувство неполноценности, подавленность.
2. Расположение на листе: 
- В центре. Центр масс всех объектов (или центр ограничивающего прямоугольника композиции) находится в пределах 40–60 % от ширины и 40–60 % от высоты листа.
- Сверху. Центр масс по вертикали ≥70 % от высоты листа.
- Снизу. Центр масс по вертикали ≤30 % от высоты листа.
- Слева. Центр масс по горизонтали ≤30 % от ширины листа.
- Справа. Центр масс по горизонтали ≥70 % от ширины листа.  
3. Сила нажима: 
    - Сильный нажим (> 1 мм). Может указывать на энергичность, импульсивность, настойчивость, иногда – на агрессивность.
    - Слабый нажим (< 1 мм). Может указывать на чувствительность, мягкость, уступчивость, астению, тревожность.
4. Характер линий: 
    Прерывистые, неровные линии (есть лесенки, штриховка)  
    - Четкие, ровные линии. Непрерывные штрихи длиной ≥15 мм без перерывов и резких «уголков» (>15°), Количество разрывов на 20 мм линии ≤2 , Вариация толщины в 
    пределах одного штриха <20 % от его средней ширины. Может указывать на контроль, рациональность, уверенность.
    - Прерывистые, неровные линии. Средняя длина непрерывного сегмента ≤10 мм ,  Количество разрывов на 20 мм линии ≥5, Отношение суммарной длины разрывов к 
    длине штриха ≥30 %, Более 5 резких изменений направления (>30°) на каждый 20 мм линии, Отношение суммарной длины «заворотов» (изломов) к общей длине 
    штриха ≥25 %, Визуально «лесенка» на диагоналях Может указывать на тревожность, неуверенность, импульсивность. 
    - Заштрихованные, затемненные линии. Наличие участков, заполненных перекрёстным штрихом (хетчинг), Плотность штрихов в таких зонах ≥5 линий на 10 мм, Контраст 
    штриховки ≥50 % от тона основного контура Может указывать на тревожность, чувство вины, подавленные эмоции.
5. Общая композиция: 
    - Гармоничная, сбалансированная композиция. Количество объектов (дом, дерево, человек и т. п.) распределено по листу равномерно: Каждый из 4 квадрантов листа 
    содержит от 15 % до 35 % общей зоны рисунка , Центр масс всех элементов находится в пределах ±10 % от геометрического центра листа; Пустых зон между 
    объектами не более 20 % площади листа;  Максимальная плотность пересечений линий не превышает 3 точек пересечения на 50 мм²..  Может указывать на 
    уравновешенность, адаптивность. 
    - Перегруженная, хаотичная композиция. Один из квадрантов содержит ≥50 % общей зоны рисунка, Центр масс смещён от центра листа на ≥20 % по любой оси, Плотность 
    пересечений линий ≥6 точек на 50 мм²; объекты часто перекрываются.Может указывать на тревожность, внутренний конфликт.озиция: Может указывать на интроверсию, 
    подавленность, чувство одиночества.
    - Пустая, минималистичная композиция. Все объекты занимают ≤30 % площади листа.  ≥40 % листа остаётся пустым без каких-либо линий. Общее число объектов ≤3, 
    пространства между ними ≥20 мм. Может указывать на интроверсию, подавленность, чувство одиночества.
Дом: 
    1. Фундамент: 
    - Отсутствие фундамента. Ни одной горизонтальной линии под стенами дома нет.  Дом «стоит» на уровне земли без чёткого основания, или линия земли проходит только 
    частично или вовсе не касается дома.
    - Слабый, нечеткий фундамент. Горизонтальная линия под домом есть, но прерывистая (≥3 разрыва на каждые 50 мм).  Толщина линии <0.5 мм или варьируется более чем 
    на 30 % от средней ширины штриха. Линия покрывает <80 % ширины дома или заметно «рваная».
    - Наличие фундамента.  Есть непрерывная горизонтальная линия прямо под стенами дома.  Длина линии ≥80 % от ширины корпуса дома.  Толщина линии ≥0.8 мм и без 
    разрывов на всём протяжении.
2. Стены:
    - Крепкие стены. Контур стен образует замкнутый прямоугольник без разрывов (≤1 пропуск на 100 мм), длина линии ≥95 % от периметра дома, средняя толщина штриха ≥0.8 мм 
    я(колебания <20 % от среднего).
    - Слабые, тонкие стены. Контур стен тонкий – средняя толщина <0.5 мм (вариация >30 % от среднего), разрывов ≥3 на каждые 50 мм контура, контур может быть частично незамкнут.
    - Заштрихованные, затемнённые стены. Стены заполнены штриховкой: плотность перекрёстных линий ≥5 на 10 мм, штриховка занимает ≥20 % площади стен, тон штриховки ≥50 % 
    темнее основного контура.
3. Крыша: 
    - Большая крыша. Форма крыши (треугольник или скаты) занимает ≥25 % общей высоты дома от основания до конька; ширина свесов или карнизов ≥90 % от ширины корпуса дома; контур 
    крыши непрерывен, толщина линии ≥0.8 мм.
    - Маленькая крыша. Высота крыши ≤10 % от общей высоты дома; ширина свесов ≤70 % от ширины корпуса; может быть одинарный скат без выраженных выступов; толщина линии <0.8 мм.
    - Отсутствие крыши. Нет отдельно выделенного элемента крыши (верхняя граница дома ровная горизонтальная линия без треугольных или скатных элементов), или дом нарисован без 
    верхней конструкции.
4. Дверь (может быть несколько вариантов для ответа: размер двери, закрытая дверь и дверь без ручки): 
    - Большая дверь. Высота двери ≥25 % от высоты корпуса дома; ширина ≥15 % от ширины корпуса дома; толщина контура ≥0.8 мм; контур двери непрерывен (≤1 разрыв на 100 мм).
    - Маленькая дверь. Высота ≤15 % от высоты дома; ширина ≤10 % от ширины дома; толщина контура <0.8 мм; разрывов в контуре ≥3 на 50 мм.
    - Закрытая дверь. Контур двери полностью замкнут, без дополнительной линии, обозначающей открытое положение (нет щели или смещения створки); створки совпадают по плоскости.
    - Дверь без ручки. На контуре двери отсутствует отметка ручки (точка или небольшой отрезок длиной 2–5 мм) в зоне 30–40 % от нижнего края двери.
5. Окна (может быть несколько вариантов для ответа: размер окна, занавески на окнах):  
    - Большие окна. Высота окна ≥20 % от высоты корпуса дома; ширина ≥20 % от ширины корпуса; площадь окна ≥4 % от площади фасада; контур окна непрерывен (≤1 разрыв на 100 мм), 
    толщина линии ≥0.8 мм.
    - Маленькие окна. Высота окна ≤10 % от высоты дома; ширина ≤10 % от ширины дома; площадь ≤1.5 % от фасада; толщина линии <0.8 мм.
    - Отсутствие окон. Ни одного замкнутого контура, соответствующего форме окна (прямоугольник, квадрат, круг), не обнаружено.
    - Занавески на окнах. Внутри рамки окна есть ≥3 параллельных или волнообразных линий длиной ≥5 мм каждая; плотность линий ≥3 на одно окно.
6.Труба: 
    - Дым из трубы. Из вершины трубы выходит от 1 до 5 волнообразных или параллельных линий длиной ≥10 мм каждая; расстояние между линиями ≤5 мм; толщина линий <0.8 мм; все линии 
    начинаются не ниже конька крыши.
    - Интенсивный дым. Из вершины трубы выходит ≥6 волнообразных или параллельных линий длиной ≥10 мм; расстояние между ними ≤3 мм; плотность линий ≥5 на 10 мм; присутствует 
    затемнённая область (штриховка) над трубой площадью ≥15 % от всей зоны дымовых линий.
    - Отсутствие дыма. На трубе (вертикальном элементе над крышей) нет ни одной линии, указывающей на дым; пространство над трубой пустое.
    - Дом без трубы. Отсутствует любой вертикальный элемент (прямоугольник или цилиндр) над крышей высотой ≥5 мм и шириной ≥3 мм, соприкасающийся с коньком или скатом.

Дерево:
1. Корни: 
- Наличие корней. Есть ≥1 отчетливая линия, отходящая от основания ствола вниз на длину ≥5 мм. Толщина каждой корневой линии ≥0.5 мм. Суммарная горизонтальная протяжённость корней 
(от самой левой до самой правой точки) ≥20 % диаметра ствола.
- Отсутствие корней. Ни одной линии не выходит из основания ствола вниз. Основание ствола упирается прямо в землю без ответвлений или наклонных отростков.
- Подчеркнутые корни. ≥3 корневые линии длиной ≥8 мм каждая. Толщина корней ≥0.8 мм. Наличие штриховки или перекрёстных линий вокруг корней (плотность ≥5 линий на 10 мм) для 
усиления визуального акцента.
2. Ствол (может быть несколько вариантов для ответа: как выглядит ствол, раны или дупла на стволе):
-Крепкий ствол. Ширина ствола ≥15 % от высоты дерева (или ≥8 мм при общем росте ~50–80 мм). Контур непрерывен (≤1 разрыв на 100 мм) и средняя толщина штриха ≥0.8 мм (колебания 
<20 % от среднего). Отклонение оси ствола от вертикали ≤5°.
- Тонкий ствол. Ширина ствола <10 % от высоты дерева (или <5 мм при росте ~50–80 мм). Средняя толщина штриха <0.5 мм или варьируется более чем на 30 %. Разрывов в контуре ≥2 на 50 мм.
- Искривленный ствол. Отклонение осевого контура от вертикали >10° в одном или нескольких местах. Не менее 2 сгибов (угол ≥15°) на каждые 50 мм высоты. Контур может образовывать 
S-образную или волнообразную форму.
- Раны, дупла на стволе. На контуре или поверхности есть ≥1 замкнутый овал/прямоугольник размером ≥3×3 мм (дупло) и/или линии-трещины длиной ≥5 мм. Вокруг «ран» присутствует штриховка
(≥3 перекрёстных линий на 10 мм) для акцента.
3. Ветви:
- Поднятые вверх ветви. ≥50 % основных ветвей отходят от ствола под углом +30°…+90° относительно горизонтали; длина каждой ветви ≥15 мм; контур ветвей непрерывен (≤1 разрыв на 100 мм) 
и средняя толщина штриха ≥0.6 мм.
- Опущенные вниз ветви. ≥50 % основных ветвей отходят от ствола под углом −30°…−90°; длина каждой ветви ≥15 мм; средняя толщина штриха <0.6 мм; контур может быть слегка прерывист (≥2 разрыва на 50 мм).
- Колючие ветви. На каждой крупной ветви есть ≥3 заострённых ответвления («шипов») длиной ≤5 мм; угол между шипом и основной ветвью ≤30°; толщина шипов ≥0.4 мм и контур шипов непрерывен.
- Обрубленные ветви. На концах ветвей присутствуют ≥2 ровных «среза» (прямых отрезков) длиной ≤3 мм; после последнего ответвления остаётся ≤5 мм стебля; контур кончика ветви непрерывен и толщина штриха варьируется <20 %.
4. Крона: 
- Пышная крона. Контур лиственной массы замкнут и занимает ≥25 % от общей высоты дерева; ширина кроны ≥120 % ширины ствола; количество нарисованных листьев или штриховых «пучков» ≥15; 
плотность листьев ≥4 линии на 10 мм² внутри кроны.
- Небольшая крона. Контур лиственной массы занимает ≤10 % от высоты дерева; ширина кроны ≤80 % ширины ствола; количество листьев ≤8; плотность листьев ≤2 линии на 10 мм².
- Отсутствие кроны. Нет замкнутого контура или штрихов, обозначающих лиственную массу; ветви обрываются без «зелёного» оформления.
5. Плоды, листья:
- Наличие плодов, листьев. На дереве присутствуют ≥5 отдельных контуров листьев или плодов; каждый контур замкнут и имеет площадь ≥5 мм²; общая заполненная ими площадь внутри кроны 
≥10 % площади кроны.
- Отсутствие плодов, листьев. Ни одного замкнутого контура, похожего на лист или плод (прямоугольник, овалы, треугольники размером ≥3×3 мм), не обнаружено.

Человек: 
1. Одежда:
- Подробная одежда. На фигуре есть ≥3 разных элемента одежды (воротник, пуговицы, карманы, узоры и т. п.); каждый элемент выделен контурами ; средняя толщина контура одежды 
≥0.6 мм; детали распределены по ≥30 % площади туловища.
- Минимальная одежда. Нарисована лишь одна простая линия (футболка, платье или штаны) без дополнительных деталей; контур одежды замкнут и длиной ≤50 % от периметра туловища; толщина 
штриха <0.5 мм.
- Неопрятная одежда. Контур одежды прерывистый (≥3 разрыва на 50 мм); есть «рваные» или «лохматые» края (неравномерность контура >30 % по толщине); элементы одежды (воротник, рукава)
изображены асимметрично или с «порванными» линиями.
2. Руки:
- Сильные руки. Длина руки (плечо–кисть) ≥30 % от общей высоты фигуры; средняя толщина штриха руки ≥0.8 мм; контур руки непрерывен (≤1 разрыв на 100 мм); угол между рукой и вертикалью 
≥20° (рука отведена от тела).
- Слабые руки. Длина руки ≤20 % от общей высоты фигуры; средняя толщина штриха руки <0.5 мм; разрывов в контуре ≥2 на 50 мм; рука расположена близко к телу (угол ≤10°).
- Спрятанные руки. Руки не видны за контуром тела или изображены короткими линиями ≤5 мм в зоне бёдер; отсутствуют замкнутые контуры кистей.
- Руки, направленные на себя. Руки согнуты в локтях с углом сгиба ≥45°; кисти находятся внутри контура туловища (соприкасаются или пересекают его); локти направлены к центру тела.
3. Ноги:
- Сильные ноги. Длина ног ≥40 % от общей высоты фигуры; ширина голени или бедра ≥15 % от ширины туловища; контур непрерывен (≤1 разрыв на 100 мм), средняя толщина штриха ≥0.8 мм.
- Слабые ноги. Средняя толщина штриха <0.5 мм; ширина голени или бедра ≤10 % от ширины туловища; разрывов в контуре ≥2 на 50 мм.
- Короткие ноги. Длина ног ≤30 % от общей высоты фигуры; контур непрерывен (≤1 разрыв на 100 мм), средняя толщина штриха 0.5–0.8 мм.
4. Голова: 
- Большая голова. Высота головы ≥25 % от общей высоты фигуры; ширина головы ≥30 % ширины плеч; контур непрерывен (≤1 разрыв на 100 мм); средняя толщина штриха ≥0.7 мм.
- Средняя голова. Высота головы >15 % и <25 % от общей высоты фигуры; ширина головы >20 % и <30 % ширины плеч; контур допускает до 2 разрывов на 100 мм; толщина штриха 0.5–0.7 мм.
- Маленькая голова. Высота головы ≤15 % от общей высоты фигуры; ширина головы ≤20 % ширины плеч; контур разрывистый (≥2 разрыва на 50 мм); средняя толщина штриха <0.5 мм.
5. Глаза:
- Подчеркнутые глаза. Каждый глаз обозначен замкнутым контуром (овал или круг) высотой ≥10 % от высоты головы и шириной ≥10 % ширины головы; внутри контура есть ≥1 дополнительная линия 
(зрачок или радужка) или точка диаметром ≥2 мм; толщина контура ≥0.6 мм; контур непрерывен (≤1 разрыв на 100 мм).
- Закрытые глаза. Глаз изображён одной или двумя линиями длиной ≥8 мм и толщиной ≤0.5 мм; замкнутого контура нет; нет внутренних деталей (зрачков, радужки); линии расположены в пределах
20 % высоты головы от её центра.
6. Уши:
- Большие уши. Контур уха замкнутый (полукруг или овал) высотой ≥20 % от высоты головы и шириной ≥10 % от ширины головы; средняя толщина штриха ≥0.6 мм; уши расположены по бокам головы в 
пределах центральных 50 % её высоты; контур непрерывен (≤1 разрыв на 100 мм).
- Отсутствие ушей. Ни одного замкнутого контура или полукруга по бокам головы не обнаружено; вместо ушей могут быть короткие штрихи <5 мм или вовсе нет линий, обозначающих уши.
7. Тело (может быть несколько вариантов для ответа: ширина плечь, мускулы):
- Широкие плечи. Расстояние между внешними краями плеч ≥25 % от общей высоты фигуры; ширина плеч ≥50 % от ширины туловища в области груди; контур плеч непрерывен (≤1 разрыв на 100 мм), 
средняя толщина штриха ≥0.8 мм.
- Узкие плечи. Расстояние между внешними краями плеч ≤15 % от общей высоты фигуры; ширина плеч ≤30 % от ширины туловища; контур плеч может иметь ≥2 разрыва на 50 мм, средняя толщина штриха 
<0.5 мм.
- Подчеркнутые мускулы. В области бицепсов/грудных мышц есть ≥2 дополнительных замкнутых контурных линии длиной ≥5 мм каждая; толщина этих линий ≥0.6 мм и они выступают над основным
контуром тела, создавая рельеф.

Ответ дай в формате:





""".strip()

# Промпт для категории «Несуществующее животное»
PROMPT_ANIMAL = """
    Перед тобой — скан или фотография детского рисунка темы «Дом, дерево, человек».
    Твоя задача пройтись по каждому пункту оценки изображения и проанализировать изображение на основе этих пунктов
    Твоя задача с каждого пункта выбрать критерий, который ближе подходит к рисунку
    в ответе обязательно укажи сам критерий и что написано в нем
    Ответ дай без маркдаун разметки, но с использованием "\n" разметки
    
    Базовые критерии оценки:
    Общие характеристики и организация рисунка:
    1. Размер животного:
    - Большой: Может указывать на стремление к самоутверждению, высокую самооценку, экстраверсию, иногда компенсацию чувства неполноценности.
    - Средний: Адаптированность, уравновешенность, реалистичность.
    - Маленький: Неуверенность, застенчивость, интроверсия, чувство неполноценности.
    2. Расположение на листе:
    - В центре: Адаптивность, уравновешенность.
    - Сверху: Фантазии, идеализм, оторванность от реальности.
    - Снизу: Неуверенность, потребность в опоре.
    - Слева: Ориентация на прошлое, зависимость от матери.
    - Справа: Ориентация на будущее, зависимость от отца.
    3. Сила нажима:
    - Сильный: Энергичность, импульсивность, агрессивность.
    - Слабый: Чувствительность, тревожность, астения.
    4. Характер линий:
    - Четкие, ровные: Контроль, уверенность, рациональность.
    - Прерывистые, неровные: Тревожность, неуверенность, импульсивность.
    - Заштрихованные: Тревожность, чувство вины, подавленные эмоции.
    5. Общая композиция:
    - Сбалансированная: Уравновешенность, адаптивность.
    - Перегруженная: Тревожность, внутренний конфликт.
    - Минималистичная: Интроверсия, подавленность.
    Анализ деталей животного:
    1. Голова: Интеллектуальная сфера, контроль, самосознание.
    - Большая голова: Развитый интеллект, стремление к знаниям.
    - Маленькая голова: Интеллектуальная пассивность, неуверенность в своих способностях.
    - Глаза: Контакт с внешним миром, социальная ориентированность.
    - Большие, широко открытые глаза: Интерес к окружающему миру, потребность в общении, любопытство.
    - Маленькие, узкие глаза: Ограниченный интерес к окружающему миру, скрытность.
    - Глаза без зрачков: Эмоциональная отстраненность, избегание контакта.
    - Подчеркнутые ресницы: Демонстративность, потребность во внимании.
    2. Рот: Агрессивность, потребность в общении, удовлетворение потребностей.
    - Большой, открытый рот: Агрессивность, потребность в выражении эмоций.
    - Рот с зубами: Агрессивность, защита, стремление к доминированию.
    - Маленький, закрытый рот: Подавление эмоций, застенчивость.
    - Отсутствие рта: Трудности в общении, подавление потребностей.
    3. Уши: Восприятие информации, отношение к критике.
    - Большие уши: Потребность во внимании, повышенная чувствительность к критике.
    - Маленькие уши: Игнорирование мнения других, независимость.
    - Отсутствие ушей: Отрицание внешней информации, замкнутость.
    4. Рога, когти, зубы, шипы: Защита, агрессия, стремление к доминированию.
    - Большое количество рогов, когтей, зубов, шипов: Высокий уровень агрессии, потребность в защите.
    - Отсутствие рогов, когтей, зубов, шипов: Отсутствие агрессии, беззащитность, слабость.
    5. Крылья, плавники, перепонки: Стремление к свободе, независимости, адаптивности.
    - Наличие крыльев: Стремление к свободе, фантазиям, уходу от реальности.
    - Наличие плавников: Адаптивность, приспособляемость к различным условиям.
    6. Хвост: Контроль, импульсивность, влияние прошлого.
    - Длинный хвост: Влияние прошлого, воспоминания, привязанность.
    - Короткий хвост: Импульсивность, недостаток контроля.
    - Поднятый вверх хвост: Уверенность, оптимизм.
    - Опущенный вниз хвост: Подавленность, пессимизм.
    Анализ названия животного и описания:
    1. Название: Может отражать особенности личности, страхи, желания, ассоциации.
    - Простое, понятное название: Реалистичность, адаптивность.
    - Сложное, необычное название: Фантазия, креативность.
    - Агрессивное, угрожающее название: Агрессивность, потребность в доминировании.
    - Смешное, нелепое название: Юмор, самоирония, отрицание проблем.
    2. Описание: Может раскрыть отношение ребенка к животному, его характер, сильные и слабые стороны.
    - Описание животного как сильного, смелого, уверенного: Стремление к этим качествам, высокая самооценка.
    - Описание животного как слабого, беззащитного, нуждающегося в помощи: Низкая самооценка, потребность в защите.
    - Описание животного как доброго, дружелюбного: Стремление к общению, потребность в любви и принятии.
    - Описание животного как злого, агрессивного: Агрессивность, подавленные эмоции.
    3. Среда обитания и образ жизни животного:
    - Место обитания: Может указывать на предпочтения, интересы и страхи ребенка. (Например, если животное живет в темноте, это может указывать на страхи темноты или неизведанного).
    - Способ питания: Может указывать на удовлетворение потребностей (как физических, так и эмоциональных).
    - Взаимодействие с другими животными: Может отражать особенности межличностных отношений ребенка.
    """.strip()

    # Промпт для категории «Автопортрет»
PROMPT_SELF_PORTRAIT = """
    Перед тобой — скан или фотография детского рисунка темы «Дом, дерево, человек».
    Твоя задача пройтись по каждому пункту оценки изображения и проанализировать изображение на основе этих пунктов
    Твоя задача с каждого пункта выбрать критерий, который ближе подходит к рисунку
    в ответе обязательно укажи сам критерий и что написано в нем
    Ответ дай без маркдаун разметки, но с использованием "\n" разметки
    
    Базовые критерии оценки:
    I. Общие характеристики и организация рисунка:
    1. Размер фигуры:
    - Большой размер: Может указывать на высокую самооценку, уверенность в себе, стремление к демонстрации, потребность во внимании. Иногда - компенсация чувства неполноценности.
    - Средний размер: Адаптированность, реалистичность, адекватная самооценка.
    - Маленький размер: Неуверенность, застенчивость, низкая самооценка, чувство неполноценности.
    2. Расположение на листе:
    - В центре: Уверенность, потребность в признании, адекватная самооценка.
    - Сверху: Идеализм, высокие амбиции, оторванность от реальности. Может указывать на завышенную самооценку.
    - Снизу: Неуверенность, потребность в опоре, зависимость от других. Может указывать на заниженную самооценку.
    - Слева: Интроверсия, ориентация на прошлое, зависимость от матери. Может указывать на рефлексию и самоанализ.
    - Справа: Экстраверсия, ориентация на будущее, потребность в общении. Может указывать на стремление к новым впечатлениям и контактам.
    3. Сила нажима:
    - Сильный: Энергичность, импульсивность, уверенность.
    - Слабый: Чувствительность, тревожность, астения, неуверенность.
    4. Характер линий:
    - Четкие, ровные: Контроль, уверенность, рациональность.
    - Прерывистые, неровные: Тревожность, неуверенность, импульсивность.
    - Заштрихованные: Тревожность, чувство вины, подавленные эмоции, ощущение дискомфорта.
    5. Общая композиция:
    - Сбалансированная: Гармоничное восприятие себя, уравновешенность.
    - Перегруженная: Тревожность, внутренний конфликт, переизбыток эмоций.
    - Минималистичная: Интроверсия, подавленность, чувство одиночества, недостаток энергии.
    II. Анализ деталей фигуры:
    1. Голова: Интеллектуальная сфера, самосознание, контроль.
    - Большая голова: Высокая самооценка в интеллектуальной сфере, стремление к знаниям, развитое самосознание. Может указывать на интеллектуальные амбиции.
    - Маленькая голова: Низкая самооценка в интеллектуальной сфере, интеллектуальная пассивность, неуверенность в своих способностях.
    2. Лицо: Эмоциональное выражение, социальная ориентированность.
    Глаза:
    - Большие, широко открытые: Интерес к окружающему миру, потребность в общении, открытость, любопытство.
    - Маленькие, узкие: Скрытность, осторожность, ограниченный интерес к окружающему миру.
    - Глаза без зрачков: Эмоциональная отстраненность, избегание контакта.
    -  Подчеркнутые ресницы: Демонстративность, потребность во внимании, кокетство.
    Рот:
    - Улыбка: Позитивное отношение к себе, хорошее настроение, дружелюбие.
    - Прямая линия: Контроль, сдержанность, подавление эмоций.
    - Опущенные уголки рта: Пессимизм, подавленность, грусть.
    - Большой, открытый рот: Агрессивность, потребность в выражении эмоций (в зависимости от контекста может быть просто разговорчивость).
    Уши:
    - Большие уши: Потребность во внимании, повышенная чувствительность к критике.
    - Маленькие уши: Игнорирование мнения других, независимость.
    - Отсутствие ушей: Отрицание внешней информации, замкнутость.
    3. Тело: Физическое “Я”, сила, энергия, самооценка.
    - Широкие плечи: (Для мальчиков) Стремление к силе, доминированию, уверенность в себе.
    - Узкие плечи: Чувство неполноценности, слабость, неуверенность (чаще у мальчиков).
    - Тонкая шея: Чувствительность, уязвимость, хрупкость.
    - Короткая шея: Упрямство, ригидность, недостаток гибкости.
    - Подчеркнутая талия: (Для девочек) Интерес к своей внешности, стремление к привлекательности.
    4. Руки: Способ взаимодействия с окружающим миром, активность.
    - Длинные, сильные руки: Активность, уверенность в себе, способность достигать целей.
    - Короткие, слабые руки: Пассивность, зависимость, неуверенность в своих силах.
    - Спрятанные за спиной руки: Чувство вины, стеснительность, нежелание действовать.
    - Руки, направленные на себя: Аутоагрессия, самокритика.
    5. Ноги: Опора, связь с реальностью, устойчивость, уверенность.
    - Длинные, сильные ноги: Уверенность в себе, стремление к независимости, активная жизненная позиция.
    - Короткие, слабые ноги: Неуверенность, зависимость от других, потребность в опоре.
    6. Одежда: Способ самопредставления, социальные нормы, стремление к соответствию.
    - Подробная, тщательно прорисованная одежда: Стремление произвести впечатление, потребность во внимании, соответствие социальным нормам.
    - Схематичная одежда: Скромность, нежелание привлекать внимание, безразличие к социальным нормам.
    - Неопрятная одежда: Пренебрежение к себе, низкая самооценка, бунтарство.

""".strip()

task_store = {}

def process_images(task_id: str, encoded: List[tuple]):
    """
    Фоновая функция: получает список (content_type, base64) и
    пишет результат в task_store[task_id].
    """
    # Составляем content для OpenAI
    prompts = [
        ("Рисунок 1 (Дом/Дерево/Человек)", PROMPT_HOUSE_TREE_PERSON),
        ("Рисунок 2 (Несуществующее животное)", PROMPT_ANIMAL),
        ("Рисунок 3 (Автопортрет)", PROMPT_SELF_PORTRAIT),
    ]

    content = []
    for (title, prompt), (ct, b64) in zip(prompts, encoded):
        content.append({"type": "text", "text": f"{title}:\n{prompt}"})
        content.append({
            "type": "image_url",
            "image_url": {"url": f"data:{ct};base64,{b64}"}
        })

    # Вызываем OpenAI синхронно
    try:
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        resp = client.chat.completions.create(
            model="gpt-4.1-2025-04-14",
            messages=[{"role": "user", "content": content}],
        )
        result = resp.choices[0].message.content
        task_store[task_id] = {"status": "done", "result": result}
        print (result)
    except Exception as e:
        task_store[task_id] = {"status": "error", "error": str(e)}


@app.post("/upload")
async def upload_images(
    background_tasks: BackgroundTasks,
    files: List[UploadFile] = File(...)
):
    """
    Принимает ровно 3 файла под ключом 'files', сразу возвращает task_id.
    Фоново обрабатывает OpenAI и сохраняет результат в памяти.
    """
    if len(files) != 3:
        raise HTTPException(400, f"Ожидалось 3 файла, пришло {len(files)}")

    # Кодируем изображения
    encoded = []
    for idx, file in enumerate(files, start=1):
        if not file.content_type.startswith("image/"):
            raise HTTPException(400, f"file#{idx} не изображение: {file.content_type}")
        data = await file.read()
        b64 = base64.b64encode(data).decode("utf-8")
        encoded.append((file.content_type, b64))

    # Создаём уникальный ID задачи
    task_id = uuid.uuid4().hex
    # Сразу кладём в store статус pending
    task_store[task_id] = {"status": "pending"}

    # Запускаем фоновую задачу
    background_tasks.add_task(process_images, task_id, encoded)

    # Возвращаем task_id клиенту
    return JSONResponse(
        status_code=202,
        content={"task_id": task_id}
    )


@app.get("/status/{task_id}")
async def get_status(task_id: str):
    """
    Клиент опрашивает этот эндпоинт.
    Везде возвращаем JSON со status (pending|done|error).
    Никогда не 404.
    """
    task = task_store.get(task_id)
    if task is None:
        # Если задача ещё не зашла в store или уже выпала — считаем, что она в работе
        return {"status": "pending"}
    return task