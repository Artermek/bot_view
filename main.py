from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI
import base64
import os

app = FastAPI()

# Разрешаем запросы с основного домена и (по желанию) с доменов Тильды
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://siriusfuture.ru",
        "https://www.siriusfuture.ru",
        # Если нужно — и поддомены:
        # "https://*.siriusfuture.ru",

        # Опционально: для Тильды
        "https://*.tilda.ws",
        "https://tilda.cc",
        "https://static.tildacdn.com",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.post("/upload")
async def upload_image(file: UploadFile = File(...)):
    if not file.content_type.startswith("image/"):
        raise HTTPException(status_code=400, detail="Файл должен быть изображением")

    try:
        image_data = await file.read()
        base64_image = base64.b64encode(image_data).decode('utf-8')

        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": """Ты — ведущий нейропсихолог с 20-летним стажем, специалист в проективных методиках, в частности тесте «Дом – Дерево – Человек». Перед тобой — скан или фотография детского рисунка. Твоя задача дать рекомендации:

                                            1. **Общие впечатления**  
                                            - Оцени композицию, баланс элементов, пропорции, симметрию/асимметрию.  
                                            - Заметь особенности листа (складки, пятна, поломки карандаша) — это тоже данные о ребёнке.

                                            2. **Детальный разбор по элементам**  
                                            - **Дом**: размеры, форма, наличие крыши, окон, дверей, дымохода; открытые/закрытые двери; расположение на листе.  
                                            - **Дерево**: вид (лиственное, хвойное), ветви, листья, корни; цветовая гамма; степень детализации.  
                                            - **Человек**: пропорции тела, голова, лицо (черты, глаза, рот), руки, ноги; одежда; направление взгляда и поза; пол и возрастная идентификация.

                                            3. **Графические и моторные признаки**  
                                            - Давление карандаша (слабое/сильное).  
                                            - Линии (плавные/рывковые, ровные/неровные).  
                                            - Скорость исполнения (по разрывам, штриховке).  
                                            - Уровень развития мелкой моторики.

                                            4. **Психоэмоциональная интерпретация**  
                                            - Эмоциональный фон (тревожность, агрессия, замкнутость, уверенность).  
                                            - Отношение к родителям и дому (безопасность, враждебность, тепло).  
                                            - Внутренние конфликты, страхи (символика, цвет, пустоты).  

                                            5. **Когнитивно-развивающие показатели**  
                                            - Уровень реализма и символичности.  
                                            - Способность к абстракции, детализации.  
                                            - Соответствие возрастным нормам.

                                            6. **Рекомендации**  
                                            - Предложения по дальнейшей диагностике (какие тесты, беседы).  
                                            - Психокоррекционные мероприятия (игры, упражнения, арт-терапия).

                                            **Формат ответа**:  
                                            - Выводи текстовыми разделами с заголовками «1. Общие впечатления», «2. Дом», «3. Дерево» и т. д.  
                                            - В каждом разделе давай чёткие наблюдения и интерпретации.  
                                            - В конце подведи краткий итог и сформулируй рекомендации.

                                            Начинай ответ со слов: «В качестве ведущего нейропсихолога предлагаю следующий анализ…»  """},
                        
                        {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}},
                    ],
                }
            ],
        )

        analysis = response.choices[0].message.content
        print (analysis)
        return JSONResponse(content={"analysis": analysis})

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ошибка обработки запроса: {e}")
