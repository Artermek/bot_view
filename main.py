from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI
import base64
import os

app = FastAPI()

# Разрешаем запросы с основного домена и (по желанию) с доменов Тильды
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://siriusfuture.ru",
        "https://www.siriusfuture.ru",
        # Если нужно — и поддомены:
        # "https://*.siriusfuture.ru",

        # Опционально: для Тильды
        "https://*.tilda.ws",
        "https://tilda.cc",
        "https://static.tildacdn.com",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.post("/upload")
async def upload_image(file: UploadFile = File(...)):
    if not file.content_type.startswith("image/"):
        raise HTTPException(status_code=400, detail="Файл должен быть изображением")

    try:
        image_data = await file.read()
        base64_image = base64.b64encode(image_data).decode('utf-8')

        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": """Перед тобой — скан или фотография детского рисунка. Твоя задача на основе критериев оценки
                                    проанализировать фотографию и в каждом пункте выбрать критерий, который ближе подходит к рисунку
                                    Если тебе отправили фотографию, которая не похожа на рисунок, то ответь фразу заглушку: Это не похоже на детский рисунок, 
                                    пожалуйста, отправти другое изображение или отправте более четкий снимок 

                                    Базовые критерии оценки рисунка:
                                    I. Общие характеристики и организация рисунка:
                                    1. Размер рисунка:
                                    - Большой размер: Может указывать на экстраверсию, уверенность в себе, экспансивность, иногда – на потребность в признании или компенсирующую гигантоманию.
                                    - Маленький размер: Может указывать на интроверсию, неуверенность, застенчивость, чувство неполноценности, подавленность.
                                    2. Расположение на листе:
                                    - В центре: Может указывать на адаптивность, уравновешенность, потребность в признании.
                                    - Сверху: Может указывать на идеализм, ориентацию на будущее, фантазии, иногда – на оторванность от реальности.
                                    - Снизу: Может указывать на ориентацию на прошлое, чувство незащищенности, потребность в опоре.
                                    - Слева: Может указывать на ориентацию на прошлое, интроверсию, зависимость от материнской фигуры.
                                    - Справа: Может указывать на ориентацию на будущее, экстраверсию, потребность в общении, зависимость от отцовской фигуры.
                                    3. Сила нажима:
                                    - Сильный нажим: Может указывать на энергичность, импульсивность, настойчивость, иногда – на агрессивность.
                                    - Слабый нажим: Может указывать на чувствительность, мягкость, уступчивость, астению, тревожность.
                                    4. Характер линий:
                                    - Четкие, ровные линии: Может указывать на контроль, рациональность, уверенность.
                                    - Прерывистые, неровные линии: Может указывать на тревожность, неуверенность, импульсивность.
                                    - Заштрихованные, затемненные линии: Может указывать на тревожность, чувство вины, подавленные эмоции.
                                    5. Общая композиция:
                                    - Гармоничная, сбалансированная композиция: Может указывать на уравновешенность, адаптивность.
                                    - Перегруженная, хаотичная композиция: Может указывать на тревожность, внутренний конфликт.
                                    - Пустая, минималистичная композиция: Может указывать на интроверсию, подавленность, чувство одиночества.
                                    II. Оценка рисунка Дома:
                                    1. Общее впечатление: Дом – символ “Я”, семейных отношений, безопасности.
                                    2. Фундамент: Опора, связь с реальностью, уверенность.
                                    - Наличие фундамента: Устойчивость, реалистичность.
                                    - Отсутствие фундамента: Неуверенность, оторванность от реальности.
                                    - Слабый, нечеткий фундамент: Неуверенность, потребность в опоре.
                                    3. Стены: Границы “Я”, способ взаимодействия с внешним миром.
                                    - Крепкие стены: Сильное “Я”, уверенность в себе.
                                    - Слабые, тонкие стены: Чувствительность, уязвимость.
                                    - Заштрихованные стены: Тревожность, чувство вины.
                                    4. Крыша: Интеллектуальная сфера, фантазии, контроль.
                                    - Большая крыша: Развитая фантазия, интеллектуальные интересы.
                                    - Маленькая крыша: Ограниченность фантазии, рациональность.
                                    - Отсутствие крыши: Импульсивность, недостаток контроля.
                                    5. Дверь: Доступность, открытость, способ взаимодействия с другими людьми.
                                    - Большая дверь: Экстраверсия, потребность в общении.
                                    - Маленькая дверь: Интроверсия, замкнутость.
                                    - Закрытая дверь: Недоступность, замкнутость.
                                    - Дверь без ручки: Нежелание общаться.
                                    6. Окна: Контакт с внешним миром, наблюдательность.
                                    - Большие окна: Интерес к окружающему миру, потребность в общении.
                                    - Маленькие окна: Ограниченный интерес к окружающему миру.
                                    - Занавески на окнах: Желание скрыть что-то от других.
                                    - Отсутствие окон: Изоляция, отчужденность.
                                    7. Труба: Символ тепла, близости, сексуальности.
                                    - Дым из трубы: Эмоциональная теплота, потребность в близости.
                                    - Отсутствие дыма: Подавление эмоций.
                                    - Интенсивный дым: Тревожность, напряжение.
                                    - Труба без дома: Оторванность от реальности, фантазии.
                                    III. Оценка рисунка Дерева:
                                    1. Общее впечатление: Дерево – символ развития, жизненной силы, самооценки.
                                    2. Корни: Связь с прошлым, стабильность, уверенность.
                                    - Наличие корней: Устойчивость, связь с реальностью.
                                    - Отсутствие корней: Неуверенность, оторванность от реальности.
                                    - Подчеркнутые корни: Тревожность, потребность в защите.
                                    3. Ствол: Сила “Я”, адаптивность, способность к выживанию.
                                    - Крепкий ствол: Сильное “Я”, устойчивость.
                                    - Тонкий ствол: Чувствительность, уязвимость.
                                    - Искривленный ствол: Внутренний конфликт, трудности адаптации.
                                    - Раны, дупла на стволе: Травматический опыт.
                                    4. Ветви: Способ взаимодействия с окружающим миром, социальные контакты.
                                    - Поднятые вверх ветви: Оптимизм, стремление к достижению.
                                    - Опущенные вниз ветви: Пессимизм, подавленность.
                                    - Колючие ветви: Агрессивность, защита.
                                    - Обрубленные ветви: Чувство утраты, ограничение возможностей.
                                    5. Крона: Интеллектуальная сфера, фантазии, творчество.
                                    - Пышная крона: Развитая фантазия, творческие способности.
                                    - Небольшая крона: Ограниченность фантазии, рациональность.
                                    - Отсутствие кроны: Интеллектуальная пассивность.
                                    6. Плоды, листья: Достижения, результаты деятельности, ресурсы.
                                    - Наличие плодов, листьев: Плодотворность, ресурсность.
                                    - Отсутствие плодов, листьев: Неудовлетворенность, ощущение недостатка ресурсов.
                                    IV. Оценка рисунка Человека:
                                    1. Общее впечатление: Человек – символ “Я”, самооценки, идентификации.
                                    2. Голова: Интеллектуальная сфера, самосознание.
                                    - Большая голова: Высокая самооценка, интеллектуальные амбиции.
                                    - Маленькая голова: Низкая самооценка, интеллектуальная пассивность.
                                    - Подчеркнутые глаза: Интерес к окружающему миру, потребность в общении.
                                    - Закрытые глаза: Нежелание видеть, избегание.
                                    - Большие уши: Потребность во внимании, чувствительность к критике.
                                    - Отсутствие ушей: Игнорирование мнения других.
                                    3. Тело: Физическое “Я”, сила, энергия.
                                    - Широкие плечи: Стремление к власти, доминированию.
                                    - Узкие плечи: Чувство неполноценности, слабость.
                                    - Подчеркнутые мускулы: Стремление к силе, компенсация слабости.
                                    4. Руки: Способ взаимодействия с окружающим миром, активность.
                                    - Сильные руки: Активность, энергичность.
                                    - Слабые руки: Пассивность, зависимость.
                                    - Спрятанные руки: Чувство вины, неловкость.
                                    - Руки, направленные на себя: Аутоагрессия.
                                    5. Ноги: Опора, связь с реальностью, уверенность.
                                    - Сильные ноги: Устойчивость, уверенность.
                                    - Слабые ноги: Неуверенность, потребность в опоре.
                                    - Короткие ноги: Импульсивность, недостаток контроля.
                                    6.Одежда: Способ самопредставления, социальные нормы.
                                    - Подробная одежда: Потребность в признании, стремление произвести впечатление.
                                    - Минимальная одежда: Скромность, простота.
                                    - Неопрятная одежда: Пренебрежение социальными нормами.


                                     """},
                        
                        {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}},
                    ],
                }
            ],
        )

        analysis = response.choices[0].message.content
        print (analysis)
        return JSONResponse(content={"analysis": analysis})

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ошибка обработки запроса: {e}")
