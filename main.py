from typing import List
import os
import base64
import uuid
from typing import Optional
from pydantic import BaseModel
from openai import AsyncOpenAI
from fastapi import HTTPException, status
from typing import Dict

from fastapi import FastAPI, UploadFile, File, HTTPException, BackgroundTasks
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI
import threading

# Если хотите хранить OPENAI_API_KEY в .env локально:
from dotenv import load_dotenv
app = FastAPI()

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://siriusfuture.ru",
        "https://www.siriusfuture.ru",
        "https://*.tilda.ws",
        "https://tilda.cc",
        "https://static.tildacdn.com",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
task_store = {}
lock = threading.Lock()

class SurveyData(BaseModel):
    childName: str
    childDOB: str
    childGender: str
    parentName: str
    q1_1: str
    q1_2: str
    q1_3: str
    q1_4: str
    q1_5: str
    q1_6: str
    q1_7: str
    q1_8: str
    q1_9: str
    q1_10: str
    q2_1: str
    q2_2: str
    q2_3: str
    q2_4: str
    q2_5: str
    q2_6: str
    q2_7: str
    q2_8: str
    q2_9: str
    q2_10: str
    q3_1: str
    q3_2: str
    q3_3: str
    q3_4: str
    q3_5: str
    q3_6: str
    q3_7: str
    q3_8: str
    q3_9: str
    q3_10: str
    q4_1: str
    q4_2: str
    q4_3: str
    q4_4: str
    q4_5: str
    q4_6: str
    q4_7: str
    q4_8: str
    q4_9: str
    q4_10: str
    emotionalState: str
    developmentFeatures: Optional[str] = None
    strengths: Optional[str] = None
    attentionAreas: Optional[str] = None
    specialists: Optional[str] = None

class PhotoAnalysis(BaseModel):
    image1: str
    image2: str
    image3: str
class AnalysisRequest(BaseModel):
    survey: SurveyData
    photos: PhotoAnalysis


# Промпт для категории «Дом, Дерево, Человек»
PROMPT_HOUSE_TREE_PERSON = """Перед  тобой — скан или фотография рисунка на тему «Дом, дерево, человек». Твоя задача провести анализ в два этапа:
сначала измерить и зафиксировать ключевые визуальные параметры, затем отнести каждое значение к одному из критериев.
В ответе укажи только результаты с Этапа 2. 


Этап 1. Извлечение признаков
Для каждого пункта замерь или оценить приблизительно в миллиметрах (или в процентах от объекта/листа):
— Общий размер рисунка (процент заполнения листа)
— Толщину линий (средняя ширина штриха в мм)
— Положение объектов (координаты центра относительно листа или «слева/в центре/справа»)
— Для дома: ширина и высота корпуса, размеры крыши, размеры двери и окон, наличие фундамента (линия земли)
— Для дерева: высота ствола, длина корней, размеры кроны
— Для человека: рост, ширина плеч, длина рук, длина ног, размер головы

Этап 2. КЛАССИФИКАЦИЯ ПО КРИТЕРИЯМ
Используя измеренные величины, для каждого пункта выбери ровно один критерий, укажи его название, условие выбора (пороговые величины) и на что этот критерий может указывать эмоционально. Приведи краткое обоснование цифрами.

Общие характеристики и организация рисунка:

Размер рисунка:
Большой размер (рисунок занимает >65 % листа). Может указывать на экстраверсию, уверенность в себе, экспансивность, иногда – на потребность в признании или компенсирующую гигантоманию.
Маленький размер (рисунок занимает <65 % листа). Может указывать на интроверсию, неуверенность, застенчивость, чувство неполноценности, подавленность.

Расположение на листе:
В центре (центр масс всех объектов находится в пределах 40–60 % по ширине и 40–60 % по высоте). Адаптивность, уравновешенность, потребность в признании.
Сверху (центр масс по вертикали ≥70 %). Фантазии, идеализм, оторванность от реальности.
Снизу (центр масс по вертикали ≤30 %). Неуверенность, потребность в опоре.
Слева (центр масс по горизонтали ≤30 %). Ориентация на прошлое, зависимость от матери, интроверсия.
Справа (центр масс по горизонтали ≥70 %). Ориентация на будущее, экстраверсия, потребность в общении, зависимость от отца.

Сила нажима:
Сильный нажим (средняя ширина штриха >1 мм). Энергичность, импульсивность, настойчивость, иногда – агрессивность.
Слабый нажим (штрих <1 мм). Чувствительность, мягкость, уступчивость, астения, тревожность.

Характер линий:
Четкие, ровные линии (непрерывные штрихи ≥15 мм, ≤2 разрыва на 20 мм, варьирование толщины <20 %). Контроль, рациональность, уверенность.
Прерывистые, неровные линии (сегмент ≤10 мм, ≥5 разрывов на 20 мм, ≥5 резких изломов >30°). Тревожность, неуверенность, импульсивность.
Заштрихованные, затемнённые линии (хетчинг ≥5 линий на 10 мм, штриховка ≥20 % контура). Тревожность, чувство вины, подавленные эмоции.

Общая композиция:
Сбалансированная (каждый из 4 квадрантов листа содержит 15–35 % рисунка, центр масс смещён ≤10 %). Уравновешенность, адаптивность.
Перегруженная, хаотичная (один квадрант ≥50 %, смещение центра ≥20 %, ≥6 пересечений линий на 50 мм²). Тревожность, внутренний конфликт.
Минималистичная (рисунок ≤30 % площади листа, ≥40 % пусто, объектов ≤3). Интроверсия, подавленность, чувство одиночества.

Оценка рисунка «Дома»:

Фундамент:
Наличие фундамента (линия ≥80 % ширины дома, толщина ≥0.8 мм, без разрывов). Устойчивость, реалистичность.
Слабый, нечеткий фундамент (линия прерывиста ≥3 разрыва на 50 мм или толщина <0.5 мм). Неуверенность, потребность в опоре.
Отсутствие фундамента (нет горизонтальной линии). Отчуждённость от реальности, нестабильность.

Стены:
Крепкие стены (контур замкнут, ≤1 разрыв на 100 мм, толщина ≥0.8 мм). Сильное “Я”, уверенность.
Слабые, тонкие стены (толщина <0.5 мм, ≥3 разрыва на 50 мм). Чувствительность, уязвимость.
Заштрихованные стены (штриховка ≥5 линий на 10 мм, ≥20 % площади). Тревожность, чувство вины.

Крыша:
Большая крыша (высота ≥25 % высоты дома, свес ≥90 % ширины). Развитая фантазия, интеллектуальные интересы.
Маленькая крыша (высота ≤10 %, свес ≤70 %). Рациональность, ограниченность фантазии.
Отсутствие крыши (нет треугольных/скатных элементов). Импульсивность, недостаток контроля.

Дверь:
Большая дверь (высота ≥25 %, ширина ≥15 %, толщина ≥0.8 мм). Экстраверсия, потребность в общении.
Маленькая дверь (высота ≤15 %, ширина ≤10 %, толщина <0.8 мм). Интроверсия, замкнутость.
Закрытая дверь (контур замкнут, без щели). Недоступность, скрытность.
Дверь без ручки (нет маркировки ручки 2–5 мм). Нежелание общаться.

Окна:
Большие окна (≥20 % высоты и ширины корпуса, площадь ≥4 % фасада). Интерес к миру, наблюдательность.
Маленькие окна (≤10 %, площадь ≤1.5 %). Ограниченный интерес к миру.
Занавески (≥3 параллелей ≥5 мм, плотность ≥3 линии/окно). Желание скрыться.
Отсутствие окон (нет замкнутых контуров). Изоляция, отчужденность.

Дым из трубы:
Дым лёгкий (1–5 линий ≥10 мм, толщина <0.8 мм). Эмоциональная теплота, потребность в близости.
Интенсивный дым (≥6 линий, плотность ≥5/10 мм, штриховка ≥15 %). Тревожность, напряжение.
Отсутствие дыма (нет линий). Подавление эмоций.
Дом без трубы (нет элемента ≥5×3 мм). Оторванность от реальности, фантазии.

Оценка рисунка «Дерева»:

Корни:
Наличие корней (линии ≥5 мм, толщина ≥0.5 мм, ширина ≥20 % диаметра ствола). Устойчивость, связь с прошлым.
Подчеркнутые корни (≥3 линии ≥8 мм, толщина ≥0.8 мм, штриховка ≥5/10 мм). Тревожность, потребность в защите.
Отсутствие корней. Неуверенность, оторванность от реальности.

Ствол:
Крепкий ствол (ширина ≥15 % высоты, контур замкнут, толщина ≥0.8 мм, отклонение ≤5°). Сила “Я”, устойчивость.
Тонкий ствол (ширина <10 %, толщина <0.5 мм, ≥2 разрыва на 50 мм). Хрупкость, чувствительность.
Искривлённый ствол (≥2 изгиба ≥15°). Внутренний конфликт, трудности адаптации.
Раны/дупла (замкнутый контур ≥3×3 мм + штриховка ≥3/10 мм). Травматический опыт.

Ветви:
Поднятые вверх (≥50 % ветвей под углом +30…+90°, длина ≥15 мм). Оптимизм, стремление к достижению.
Опущенные вниз (≥50 % ветвей под углом –30…–90°, толщина <0.6 мм). Пессимизм, подавленность.
Колючие (на каждой ветви ≥3 шипа ≤5 мм). Агрессивность, защита.
Обрубленные (≥2 «среза» ≤3 мм). Чувство утраты, ограничение возможностей.

Крона:
Пышная (контур ≥25 % высоты, ширина ≥120 % ствола, ≥15 штриховых «линий», плотность ≥4/10 мм²). Развитая фантазия, творчество.
Небольшая (контур ≤10 %, ширина ≤80 %, ≤8 листьев, плотность ≤2/10 мм²). Рациональность, ограниченность фантазии.
Отсутствие кроны. Интеллектуальная пассивность.

Плоды/листья:
Есть (≥5 замкнутых контуров ≥5 мм², зона ≥10 % кроны). Плодотворность, ресурсность.
Нет. Неудовлетворённость, ощущение нехватки ресурсов.

Оценка рисунка «Человека»:

Голова:
Большая (высота ≥25 % фигуры, ширина ≥30 % плеч, толщина ≥0.7 мм). Высокая самооценка, интеллектуальные амбиции.
Средняя (15–25 %, 20–30 %, толщина 0.5–0.7 мм). Адекватность, реалистичность.
Маленькая (≤15 %, ≤20 %, толщина <0.5 мм). Низкая самооценка, интеллектуальная пассивность.

Глаза:
Подчёркнутые (контур ≥10 % высоты и ширины головы, зрачок ≥2 мм, толщина ≥0.6 мм). Интерес к миру, потребность в общении.
Закрытые (линии ≥8 мм, толщина ≤0.5 мм, без внутренней детали). Избегание контакта, скрытность.

Уши:
Большие (контур ≥20 % высоты головы, ≥10 % ширины, толщина ≥0.6 мм). Потребность во внимании, чувствительность к критике.
Отсутствуют. Отрицание внешней информации, замкнутость.

Тело (плечи/мускулы):
Широкие плечи (между краями ≥25 % высоты фигуры, ≥50 % ширины туловища). Стремление к власти, доминированию.
Узкие плечи (≤15 % высоты, ≤30 % ширины туловища). Чувство неполноценности, слабость.
Подчёркнутые мускулы (≥2 дополнительных контурных линий ≥5 мм). Стремление к силе, компенсация слабости.

Руки:
Сильные (длина ≥30 % высоты фигуры, толщина ≥0.8 мм, угол ≥20°). Активность, энергичность.
Слабые (≤20 % высоты, толщина <0.5 мм). Пассивность, зависимость.
Спрятанные (не видны или ≤5 мм). Чувство вины, неловкость.
Направленные на себя (сгиб ≥45°, кисти внутри контура). Аутоагрессия.

Ноги:
Сильные (длина ≥40 % высоты, толщина ≥0.8 мм). Устойчивость, уверенность.
Слабые (толщина <0.5 мм, ширина ≤10 %). Неуверенность, потребность в опоре.
Короткие (≤30 % высоты). Импульсивность, недостаток контроля.

Одежда:
Подробная (≥3 элементов, толщина ≥0.6 мм, детали ≥30 % площади туловища). Потребность в признании, стремление произвести впечатление.
Минимальная (1 линия, длина ≤50 % периметра, толщина <0.5 мм). Скромность, простота.
Неопрятная (≥3 разрыва на 50 мм, неравномерность >30 %). Пренебрежение социальными нормами.

Ответ для рисунка 1 дай в формате:

Рисунок 1 (Дом/Дерево/Человек).

1. Размер рисунка: Маленький размер
2. Расположение на листе: В центре
3. Сила нажима: Слабый нажим
4. Характер линий: Прерывистые, неровные линии
5. Композиция: Гармоничная, сбалансированная композиция

Дом:

1. Фундамент: Наличие фундамента
2. Стены: Крепкие стены
3. Крыша: Большая крыша
4. Дверь: Закрытая дверь
5. Окна: Большие окна
6. Труба: Дом без трубы

Дерево:

1. Корни: Наличие корней
2. Ствол: Искривленный ствол
3. Ветви: Поднятые вверх ветви
4. Крона: Отсутствие кроны
5. Плоды, листья: Отсутствие плодов, листьев

Человек:

1. Одежда: Минимальная одежда
2. Руки: Слабые руки
3. Ноги: Слабые ноги
4. Голова: Средняя голова
5. Глаза: Подчеркнутые глаза
6. Уши: Отсутствие ушей
7. Тело: Узкие плечи

""".strip()

# Промпт для категории «Несуществующее животное»
PROMPT_ANIMAL = """
Перед тобой — скан или фотография рисунка темы «Несуществующее Животное». Твоя задача провести анализ в два этапа: сначала измерить и зафиксировать ключевые 
визуальные параметры (Этап 1), затем отнести каждое значение к одному из , используя точечные признаки и пороговые величины (Этап 2). В ответе укажи только результаты Этапа 2.

Этап 1. Извлечение признаков
Для каждого пункта измерь или оцени приблизительно:
— Размер животного: процент заполнения листа по высоте (%)
— Расположение на листе: координаты центра масс фигуры в % от ширины (горизонталь) и % от высоты (вертикаль)
— Сила нажима: средняя ширина штриха контуров (мм)
— Характер линий: длина непрерывного сегмента (мм), число разрывов на 20 мм, наличие зачёркиваний или штриховки
— Общая композиция: % рисунка в каждом из четырёх квадрантов листа, смещение центра масс от геометрического центра (смещ. %)
— Детали фигуры:
• Высота головы как % от общей высоты фигуры
• Ширина головы как % от ширины туловища
• Размер глаз: диаметр/ширина как % от ширины головы, есть / нет зрачков, количество ресниц
• Рот: высота и ширина как % от ширины головы, форма (линия/дуга/открыт)
• Уши: наличие (0/1/2), высота уха как % от высоты головы
• Рога/крылья/плавники/шипы: число или длина этих элементов (шт.)
• Хвост: длина как % от общей длины тела, направление (вверх/вниз/в сторону)
— Название и подрисуночная надпись: длина названия (количество слов), стилистика букв (прямая/закорючки)

Этап 2. Классификация по базовым критериям
Используя измеренные величины, для каждого пункта выбери ровно один критерий, приведи его название, цитату описания и обоснование на основе цифр или визуальных признаков:

Размер животного:
- Большой (занимает >65 % высоты листа). Может указывать на стремление к самоутверждению, высокую самооценку, экстраверсию, иногда компенсацию чувства неполноценности.
- Средний (35–65 % высоты). Адаптированность, уравновешенность, реалистичность.
- Маленький (<35 % высоты). Неуверенность, застенчивость, интроверсия, чувство неполноценности.

Расположение на листе:
- В центре (центр масс по горизонтали и вертикали 30–70 %). Адаптивность, уравновешенность.
- Сверху (цент масс по вертикали ≥70 %). Фантазии, идеализм, оторванность от реальности.
- Снизу (≤30 % по вертикали). Неуверенность, потребность в опоре.
- Слева (≤30 % по горизонтали). Ориентация на прошлое, зависимость от матери.
- Справа (≥70 % по горизонтали). Ориентация на будущее, зависимость от отца.

Сила нажима:
- Сильный (>1 мм). Энергичность, импульсивность, агрессивность.
- Слабый (<1 мм). Чувствительность, тревожность, астения.

Характер линий:
- Чёткие, ровные (сегмент ≥15 мм, <3 разрывов на 20 мм). Контроль, уверенность, рациональность.
- Прерывистые, неровные (сегмент ≤10 мм, ≥5 разрывов на 20 мм). Тревожность, неуверенность, импульсивность.
- Заштрихованные (штриховка ≥5 линий на 10 мм). Тревожность, чувство вины, подавленные эмоции.

Общая композиция:
- Сбалансированная (каждый квадрант 15–35 %, смещение центра ≤10 %). Уравновешенность, адаптивность.
- Перегруженная (один квадрант ≥50 %, смещение ≥20 %). Тревожность, внутренний конфликт.
- Минималистичная (рисунок ≤30 % листа, ≥40 % пусто). Интроверсия, подавленность.

Голова:
- Большая (высота >25 % фигуры). Развитый интеллект, стремление к знаниям.
- Маленькая (<15 %). Интеллектуальная пассивность, неуверенность.

Глаза:
- Большие, широко открытые (>15 % ширины головы). Интерес к миру, потребность в общении, любопытство.
- Маленькие, узкие (<10 %). Ограниченный интерес, скрытность.
- Без зрачков (зрачки не обозначены). Эмоциональная отстранённость.
- С подчёркнутыми ресницами (≥3 ресницы на глаз). Демонстративность, потребность во внимании.

Рот:
- Большой, открытый (высота >10 % высоты головы). Агрессивность, потребность в выражении эмоций.
- С зубами (замкнутые контуры с треугольными элементами). Агрессивность, защита, стремление к доминированию.
- Маленький, закрытый (<10 % ширины головы). Подавление эмоций, застенчивость.
- Отсутствие рта (нет контура). Трудности в общении, подавление потребностей.

Уши:
- Большие (>15 % высоты головы). Потребность во внимании, чувствительность к критике.
- Маленькие (<10 %). Игнорирование мнения других, независимость.
- Отсутствие ушей. Отрицание внешней информации, замкнутость.

Рога/когти/зубы/шипы:
- Много (>3 элементов). Высокий уровень агрессии, потребность в защите.
- Отсутствуют (0 элементов). Беззащитность, слабость, отсутствие агрессии.

Крылья/плавники/перепонки:
- Есть крылья. Стремление к свободе, фантазиям, уход от реальности.
- Есть плавники. Адаптивность, приспособляемость.

Хвост(несколько вариантов ответа):
- Длинный (>30 % длины тела). Влияние прошлого, привязанность.
- Короткий (<15 %). Импульсивность, недостаток контроля.
- Поднятый вверх. Уверенность, оптимизм.
- Опущенный вниз. Подавленность, пессимизм.

Название:
- Простое понятное (1–2 слова). Реалистичность, адаптивность.
- Сложное, необычное (>2 слов или неологизм). Фантазия, креативность.
- Агрессивное (угрожающее лексема). Агрессивность, потребность в доминировании.
- Смешное, нелепое (комический эффект). Юмор, самоирония.

Описание:
- Описание сильного, смелого. Стремление к силе, высокая самооценка.
- Описание слабого, беззащитного. Низкая самооценка, потребность в защите.
- Описание доброго, дружелюбного. Потребность в любви и принятии.
- Описание злого, агрессивного. Подавленные эмоции, агрессия.

Среда обитания и образ жизни:
- Тёмное место. Страхи темноты, неизведанного.
- Вода/река. Адаптивность, эмоциональная гибкость.
- Взаимодействие с другими. Социальная ориентированность или замкнутость (по числу соседних фигур).
    """.strip()

    # Промпт для категории «Автопортрет»
PROMPT_SELF_PORTRAIT = """
Перед тобой — скан или фотография рисунка на тему «Автопортрет». Твоя задача провести анализ в два этапа: сначала измерить и зафиксировать
ключевые визуальные параметры, затем отнести каждое значение к одному из критериев. 
В ответе укажи только результаты Этапа 2.
Ответ дай без маркдаун разметки, но с использованием "\n" разметки


Этап 1. Извлечение признаков
Для каждого пункта измерь или приблизительно оцени в миллиметрах или в процентах от листа/фигуры:
— Размер фигуры: процент заполнения листа по высоте.
— Расположение на листе: координаты центра масс фигуры в процентах по горизонтали и по вертикали.
— Сила нажима: средняя ширина штриха контура (мм).
— Характер линий: средняя длина непрерывного сегмента (мм), число разрывов на 20 мм, наличие штриховки.
— Общая композиция: доля рисунка в каждом из 4 квадрантов листа (%).
II. Анализ деталей фигуры:
— Голова: высота головы как % от общей высоты фигуры.
— Глаза: ширина глаза как % от ширины головы, наличие зрачков, число ресниц.
— Рот: ширина рта как % от ширины головы, форма (линия/дуга).
— Уши: наличие ушей (0, 1 или 2), высота уха как % от высоты головы.
— Плечи: ширина плеч как % от ширины туловища.
— Шея: длина шеи (мм) и толщина шеи (мм).
— Талия: ширина талии как % от ширины груди.
— Руки: длина рук как % от общей высоты фигуры.
— Ноги: длина ног как % от общей высоты фигуры.
— Одежда: доля площади одежды, занятая деталями (узоры) в %.

Этап 2. Классификация по базовым критериям
Используя измеренные величины, для каждого пункта выбери ровно один критерий из базового списка, укажи его название, описание того, на что он может 
указывать, и краткое обоснование на основе цифр.

Размер фигуры:
- Большой размер (рисунок занимает >65 % высоты листа). Может указывать на высокую самооценку, уверенность в себе, стремление к демонстрации, потребность во внимании. Иногда – компенсация чувства неполноценности.
- Средний размер (рисунок занимает 35–65 % высоты листа). Адаптированность, реалистичность, адекватная самооценка.
- Маленький размер (рисунок занимает <35 % высоты листа). Неуверенность, застенчивость, низкая самооценка, чувство неполноценности.

Расположение на листе:
- В центре (центр масс горизонтали и вертикали 30–70 %). Уверенность, потребность в признании, адекватная самооценка.
- Сверху (центр масс по вертикали ≥70 %). Идеализм, высокие амбиции, оторванность от реальности. Может указывать на завышенную самооценку.
- Снизу (центр масс по вертикали ≤30 %). Неуверенность, потребность в опоре, зависимость от других. Может указывать на заниженную самооценку.
- Слева (центр масс по горизонтали ≤30 %). Интроверсия, ориентация на прошлое, зависимость от матери. Может указывать на рефлексию и самоанализ.
- Справа (центр масс по горизонтали ≥70 %). Экстраверсия, ориентация на будущее, потребность в общении. Может указывать на стремление к новым впечатлениям и контактам.

Сила нажима:
- Сильный (ширина штриха >1 мм). Энергичность, импульсивность, уверенность.
- Слабый (ширина штриха <1 мм). Чувствительность, тревожность, астения, неуверенность.

Характер линий:
- Чёткие, ровные (длина сегмента ≥15 мм, <3 разрывов на 20 мм, вариация толщины <20 %). Контроль, уверенность, рациональность.
- Прерывистые, неровные (длина сегмента ≤10 мм, ≥5 разрывов на 20 мм, ≥5 резких изломов >30° на 20 мм). Тревожность, неуверенность, импульсивность.
- Заштрихованные (плотность штриховки ≥5 линий на 10 мм, штриховка занимает ≥20 % длины контура). Тревожность, чувство вины, подавленные эмоции, ощущение дискомфорта.

Общая композиция:
- Сбалансированная (каждый квадрант содержит 15–35 % рисунка, центр масс смещён ≤10 %). Гармоничное восприятие себя, уравновешенность.
- Перегруженная (один квадрант ≥50 %, центр масс смещён ≥20 %, ≥6 точек пересечения на 50 мм²). Тревожность, внутренний конфликт, переизбыток эмоций.
- Минималистичная (рисунок занимает ≤30 % площади листа, ≥40 % листа пусто, объектов ≤3). Интроверсия, подавленность, чувство одиночества, недостаток энергии.

Голова:
- Большая голова (высота головы >25 % от высоты фигуры). Высокая самооценка в интеллектуальной сфере, стремление к знаниям, развитое самосознание. Может указывать на интеллектуальные амбиции.
- Маленькая голова (высота головы <15 % от высоты фигуры). Низкая самооценка в интеллектуальной сфере, интеллектуальная пассивность, неуверенность в своих способностях.

Глаза:
- Большие, широко открытые (ширина глаза >15 % ширины головы). Интерес к окружающему миру, потребность в общении, открытость, любопытство.
- Маленькие, узкие (ширина глаза <10 % ширины головы). Скрытность, осторожность, ограниченный интерес к окружающему миру.
- Глаза без зрачков (зрачки не обозначены). Эмоциональная отстранённость, избегание контакта.
- Подчёркнутые ресницы (ресниц ≥3 на глаз). Демонстративность, потребность во внимании, кокетство.

Рот:
- Улыбка (дугообразный контур, уголки рта выше средней линии). Позитивное отношение к себе, хорошее настроение, дружелюбие.
- Прямая линия (контур ровный без дуги). Контроль, сдержанность, подавление эмоций.
- Опущенные уголки рта (уголки ниже средней линии). Пессимизм, подавленность, грусть.
- Большой, открытый рот (высота рта >10 % высоты головы, отдельные штрихи). Агрессивность, потребность в выражении эмоций (в зависимости от контекста может быть просто разговорчивость).

Уши:
- Большие уши (высота уха >15 % высоты головы). Потребность во внимании, повышенная чувствительность к критике.
- Маленькие уши (высота уха <10 % высоты головы). Игнорирование мнения других, независимость.
- Отсутствие ушей (уши не нарисованы). Отрицание внешней информации, замкнутость.

Плечи:
- Широкие плечи (ширина плеч ≥100 % ширины головы). (Для мальчиков) Стремление к силе, доминированию, уверенность в себе.
- Узкие плечи (ширина плеч <80 % ширины головы). Чувство неполноценности, слабость, неуверенность.

Шея:
- Тонкая шея (толщина шеи <5 % ширины туловища). Чувствительность, уязвимость, хрупкость.
- Короткая шея (длина шеи <5 % высоты фигуры). Упрямство, ригидность, недостаток гибкости.

Талия:
- Подчёркнутая талия (ширина талии <80 % ширины плеч). (Для девочек) Интерес к своей внешности, стремление к привлекательности.

Руки:
- Длинные, сильные руки (длина рук >40 % высоты фигуры). Активность, уверенность в себе, способность достигать целей.
- Короткие, слабые руки (длина рук <20 % высоты фигуры). Пассивность, зависимость, неуверенность в своих силах.
- Спрятанные за спиной руки (руки не видны спереди). Чувство вины, стеснительность, нежелание действовать.
- Руки, направленные на себя (руки согнуты к туловищу). Аутоагрессия, самокритика.

Ноги:
- Длинные, сильные ноги (длина ног >50 % высоты фигуры). Уверенность в себе, стремление к независимости, активная жизненная позиция.
- Короткие, слабые ноги (длина ног <35 % высоты фигуры). Неуверенность, зависимость от других, потребность в опоре.

Одежда:
- Подробная, тщательно прорисованная одежда (узоров ≥5 на 10 см²). Стремление произвести впечатление, потребность во внимании, соответствие социальным нормам.
- Схематичная одежда (узоров нет). Скромность, нежелание привлекать внимание, безразличие к социальным нормам.
- Неопрятная одежда (линии неровные, «рваные»). Пренебрежение к себе, низкая самооценка, бунтарство.

""".strip()



async def request(system, user, model='gpt-4.1-mini', temp=None, format: dict=None):

        client = AsyncOpenAI()
        messages = [
            {'role': 'system', 'content': system},
            {'role': 'user', 'content': user}
        ]

        try:
            response = await client.chat.completions.create(
                model=model,
                messages=messages,
                temperature=temp,
                response_format=format
            )

            if response.choices:
                return response.choices[0].message.content
            else:
                raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                                    detail='Не удалось получить ответ от модели.')

        except Exception as e:
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                                detail=f'Ошибка при запросе в OpenAI: {e}') 
def process_image(task_id: str, image_key: str, ct: str, b64: str, prompt: str):
    """
    Отправляет одно изображение с промптом в OpenAI и сохраняет результат в task_store.
    """
    try:
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        content = [
            {"type": "text", "text": prompt},
            {"type": "image_url", "image_url": {"url": f"data:{ct};base64,{b64}"}}
        ]
        resp = client.chat.completions.create(
            model="gpt-4.1-2025-04-14",  # Используйте актуальную модель
            messages=[{"role": "user", "content": content}],
        )
        result = resp.choices[0].message.content
        with lock:
            task_store[task_id]["results"][image_key] = result
            # Проверяем, все ли результаты получены
            if all(task_store[task_id]["results"].values()):
                task_store[task_id]["status"] = "done"
    except Exception as e:
        with lock:
            task_store[task_id]["results"][image_key] = {"error": str(e)}
            task_store[task_id]["status"] = "error"

@app.post("/upload")
async def upload_images(
    background_tasks: BackgroundTasks,
    files: List[UploadFile] = File(...)
):
    if len(files) != 3:
        raise HTTPException(400, f"Ожидалось 3 файла, пришло {len(files)}")

    encoded = []
    for idx, file in enumerate(files, start=1):
        if not file.content_type.startswith("image/"):
            raise HTTPException(400, f"file#{idx} не изображение: {file.content_type}")
        data = await file.read()
        b64 = base64.b64encode(data).decode("utf-8")
        encoded.append((file.content_type, b64))

    task_id = uuid.uuid4().hex
    with lock:
        task_store[task_id] = {
            "status": "pending",
            "results": {
                "image1": None,
                "image2": None,
                "image3": None
            }
        }

    prompts = [
        PROMPT_HOUSE_TREE_PERSON,
        PROMPT_ANIMAL,
        PROMPT_SELF_PORTRAIT
    ]

    # Запускаем обработку каждого изображения в отдельной фоновой задаче
    for i, (ct, b64) in enumerate(encoded):
        image_key = f"image{i+1}"
        prompt = prompts[i]
        background_tasks.add_task(process_image, task_id, image_key, ct, b64, prompt)

    return JSONResponse(
        status_code=202,
        content={"task_id": task_id}
    )

@app.get("/status/{task_id}")
async def get_status(task_id: str):
    with lock:
        task = task_store.get(task_id)
    if task is None:
        return {"status": "pending"}
    if task["status"] == "done":
        return {"status": "done", "results": task["results"]}
    elif task["status"] == "error":
        return {"status": "error", "errors": {k: v for k, v in task["results"].items() if isinstance(v, dict) and "error" in v}}
    else:
        return {"status": "pending"}
    
    
    
    
# Новая модель для данных анкеты

# Функция подсчета баллов
def calculate_survey_scores(survey_data: Dict[str, str]) -> Dict[str, int]:
    """
    Подсчитывает баллы по каждому разделу анкеты, суммируя значения вопросов.
    
    Args:
        survey_data (Dict[str, str]): Данные анкеты, где значения вопросов представлены строками ("1"–"5").
    
    Returns:
        Dict[str, int]: Словарь с суммами баллов по разделам: {'section_1': int, 'section_2': int, 
                        'section_3': int, 'section_4': int, 'total': int}.
    """
    # Список вопросов по разделам
    sections = {
        'section_1': [f'q1_{i}' for i in range(1, 11)],
        'section_2': [f'q2_{i}' for i in range(1, 11)],
        'section_3': [f'q3_{i}' for i in range(1, 11)],
        'section_4': [f'q4_{i}' for i in range(1, 11)]
    }
    
    # Инициализация словаря для хранения баллов
    scores = {
        'section_1': 0,
        'section_2': 0,
        'section_3': 0,
        'section_4': 0
    }
    
    # Подсчет баллов по каждому разделу
    for section, questions in sections.items():
        for question in questions:
            score = int(survey_data[question])  # Преобразуем строковое значение в число
            scores[section] += score
    
    # Общий балл
    scores['total'] = sum(scores[section] for section in sections.keys())
    
    return scores

# Обновленный эндпоинт для приема анкеты
@app.post("/submit-survey")
async def submit_survey(survey: SurveyData):
    # Преобразуем данные в словарь
    survey_dict = survey.dict()
    
    # Подсчитываем баллы
    scores = calculate_survey_scores(survey_dict)
    
    # Извлекаем текст из открытых вопросов
    open_questions = {
        'developmentFeatures': survey_dict.get('developmentFeatures', ''),
        'strengths': survey_dict.get('strengths', ''),
        'attentionAreas': survey_dict.get('attentionAreas', ''),
        'specialists': survey_dict.get('specialists', '')
    }
    
    # Формируем промпт для модели
    system_prompt = "Вы — опытный психолог, анализирующий ответы родителей на открытые вопросы анкеты о развитии ребенка."
    user_prompt = f"""
    Проанализируйте следующие ответы на открытые вопросы анкеты:
    
    1. Особенности развития или поведения ребенка: {open_questions['developmentFeatures']}
    2. Сильные стороны и таланты ребенка: {open_questions['strengths']}
    3. Области, требующие особого внимания: {open_questions['attentionAreas']}
    4. Обращение к специалистам: {open_questions['specialists']}
    
    Дайте краткий анализ и рекомендации на основе этих данных.
    
    """
    
    # Вызываем API модели для анализа
    try:
        analysis = await request(
            system=system_prompt,
            user=user_prompt,
            model='gpt-4.1-mini',
            temp=0.1
        )
    except Exception as e:
        analysis = f"Ошибка при анализе открытых вопросов: {str(e)}"
    
    # Выводим данные анкеты и баллы в терминал
    print("Получены данные анкеты:")
    print(survey_dict)
    print("Баллы по разделам:")
    print(scores)
    print("Анализ открытых вопросов:")
    print(analysis)
    
    # Возвращаем ответ с баллами и анализом
    return {
        "message": "Анкета успешно отправлена",
        "scores": {
            "Эмоциональная сфера": scores['section_1'],
            "Социальное взаимодействие": scores['section_2'],
            "Саморегуляция и поведение": scores['section_3'],
            "Самооценка и уверенность": scores['section_4'],
            "Общий балл": scores['total']
        },
        "analysis": analysis
    }
 
 
@app.post("/analyze-survey-and-photos")
async def analyze_survey_and_photos(data: AnalysisRequest):
    survey_dict = data.survey.dict()
    task_id = data.task_id

    # Получаем результаты анализа фотографий из task_store
    with lock:
        task = task_store.get(task_id)
    if not task or task["status"] != "done":
        raise HTTPException(status_code=404, detail="Анализ фотографий не завершен или task_id не найден")

    photo_results = task["results"]

    # Подсчитываем баллы опросника
    scores = calculate_survey_scores(survey_dict)

    # Извлекаем текст из открытых вопросов
    open_questions = {
        'developmentFeatures': survey_dict.get('developmentFeatures', ''),
        'strengths': survey_dict.get('strengths', ''),
        'attentionAreas': survey_dict.get('attentionAreas', ''),
        'specialists': survey_dict.get('specialists', '')
    }

    # Формируем промпт для GPT
    system_prompt = """
    Вы — опытный детский психолог, специализирующийся на анализе данных опросников и интерпретации детских рисунков. 
    Ваша задача — проанализировать результаты опросника и анализ фотографий, чтобы дать рекомендации по развитию ребенка.
    """
    user_prompt = f"""
    Проанализируйте следующие данные опросника и результаты анализа фотографий ребенка:

    **Данные опросника:**
    - Имя ребенка: {survey_dict['childName']}
    - Дата рождения: {survey_dict['childDOB']}
    - Пол: {survey_dict['childGender']}
    - Имя родителя: {survey_dict['parentName']}
    - Баллы по разделам:
      - Эмоциональная сфера: {scores['section_1']}
      - Социальное взаимодействие: {scores['section_2']}
      - Саморегуляция и поведение: {scores['section_3']}
      - Самооценка и уверенность: {scores['section_4']}
      - Общий балл: {scores['total']}
    - Эмоциональное состояние: {survey_dict['emotionalState']}
    - Особенности развития: {open_questions['developmentFeatures']}
    - Сильные стороны: {open_questions['strengths']}
    - Области, требующие внимания: {open_questions['attentionAreas']}
    - Обращение к специалистам: {open_questions['specialists']}

    **Анализ фотографий:**
    - Фотография 1 (Дом-Дерево-Человек): {photo_results['image1']}
    - Фотография 2 (Животное): {photo_results['image2']}
    - Фотография 3 (Автопортрет): {photo_results['image3']}

    На основе этих данных предоставьте:
    1. Общий анализ эмоционального состояния и развития ребенка.
    2. Рекомендации для родителей или специалистов.
    3. Укажите, если требуется дополнительная консультация специалистов.
    """
    
    # Вызываем GPT для анализа
    try:
        analysis = await request(
            system=system_prompt,
            user=user_prompt,
            model='gpt-4.1-2025-04-14',
            temp=0.1
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ошибка при анализе данных: {str(e)}")

    # Возвращаем ответ
    return {
        "message": "Анализ успешно завершен",
        "analysis": analysis,
        "scores": {
            "Эмоциональная сфера": scores['section_1'],
            "Социальное взаимодействие": scores['section_2'],
            "Саморегуляция и поведение": scores['section_3'],
            "Самооценка и уверенность": scores['section_4'],
            "Общий балл": scores['total']
        }
    }